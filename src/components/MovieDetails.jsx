import { useState, useEffect } from "react";
import { KEY } from "../App";
import { Loader } from "./Loader";
import StarRating from "./StarRating";

export function MovieDetails({
  selectedId,
  onCloseMovie,
  onAddWatched,
  watched,
}) {
  const [movie, setMovie] = useState({});
  const [isLoading, setIsLoading] = useState(false);
  const [userRating, setUserRating] = useState("");

  const isWatched = watched.find((movie) => movie.imdbID === selectedId);
  const watchedUserRating = isWatched?.userRating;

  // deconstruct the movie so that we don't have to use capitals when dealing with the watched movies
  const {
    Title: title,
    Year: year,
    Poster: poster,
    Runtime: runtime,
    imdbRating: imdbRating,
    Plot: plot,
    Released: released,
    Actors: actors,
    Director: director,
    Genre: genre,
  } = movie;

  function handleAdd() {
    const newWatchedMovie = {
      imdbID: selectedId,
      title,
      year,
      poster,
      imdbRating: Number(imdbRating),
      runtime: runtime.split(" ").at(0),
      userRating,
    };

    onAddWatched(newWatchedMovie);
    onCloseMovie();
  }

  useEffect(
    function () {
      async function getMovieDetails() {
        setIsLoading(true);
        const res = await fetch(
          `http://www.omdbapi.com/?apikey=${KEY}&i=${selectedId}`
        );

        const data = await res.json();
        setMovie(data);
        setIsLoading(false);
      }

      getMovieDetails();
    },
    /* This effect needs to be performed whenever the selectedId state has a change*/
    [selectedId]
  );

  useEffect(
    function updateTitle() {
      if (!title) return;
      document.title = `Movie | ${title}`;

      /* After closing a movie, this side effect will still be occuring, this is a usecase for when I may 
      want to use the clean up function
      
      The cleanUp function, despite running after the component has unmounted, still knows what the title is.
      This is because of closure in JS. title was already created by the time the effect was first created.
      So even after the component has already unmounted, the useEFfect function has already closed over the title variable
      thus allowing cleanUp to still access it

      When switching to a different movie, React will cleanUp from the previous movie
      */
      return function cleanUp() {
        document.title = "usePopcorn";
        console.log(`Clean up effect for movie ${title}`);
      };
    },
    [title]
  );

  return (
    <div className="details">
      {isLoading ? (
        <Loader />
      ) : (
        <>
          <header>
            <img src={poster} alt={`poster of ${movie}`} />

            <div className="details-overview">
              <h2>{title}</h2>
              <p>
                {released} &bull; {runtime}
              </p>
              <p>{genre}</p>
              <p>
                <span>‚≠êÔ∏è</span>
                {imdbRating} IMDb rating
              </p>
            </div>
          </header>
          <section>
            <div className="rating">
              {!isWatched ? (
                <>
                  <StarRating
                    maxRating={10}
                    size={24}
                    onSetRating={setUserRating}
                  />
                  {userRating > 0 && (
                    <button className="btn-add" onClick={handleAdd}>
                      + Add to list
                    </button>
                  )}
                </>
              ) : (
                <p>
                  you rated this movie {watchedUserRating} <span>üåü</span>
                </p>
              )}
            </div>
            <p>
              <em>{plot}</em>
            </p>
            <p>Starring {actors}</p>
            <p>Directed by {director}</p>
          </section>
          <button className="btn-back" onClick={onCloseMovie}>
            &larr; {/*left arrow*/}
          </button>
        </>
      )}
    </div>
  );
}
